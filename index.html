
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Classdash</title>
<link id="favicon" rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48c3R5bGU+LmN7ZmlsbDojM2Y1MWI1O30udHtmaWxsOiNmZmY7Zm9udC1zaXplOjU1cHg7Zm9udC1mYW1pbHk6Um9ib3RvLEFyaWFsLHNhbnMtc2VyaWY7Zm9udC13ZWlnaHQ6NzAwO308L3N0eWxlPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjIiIGNsYXNzPSJjIi8+PHRleHQgeD0iMTciIHk9IjY4IiBjbGFzcz0idCI+Q0Q8L3RleHQ+PC9zdmc+">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  :root {
    --accent-light: #3f51b5;
    --accent-dark: #7986cb;
    
    --bg: #fafafa;
    --card: #fff;
    --text: #212121;
    --muted: #757575;
    --accent: var(--accent-light);
    --border: #e0e0e0;
  }
  [data-theme="dark"] {
    --bg: #121212;
    --card: #1e1e1e;
    --text: #e0e0e0;
    --muted: #9e9e9e;
    --accent: var(--accent-dark);
    --border: #333;
  }

  /* Base */
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    background: var(--bg); color: var(--text);
    transition: background .25s ease, color .25s ease;
  }

  /* App bar */
  header {
    background: var(--accent); color: #fff;
    padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,.2);
    position: sticky; top: 0; z-index: 100;
    animation: slideDown 0.5s 0.1s ease-out backwards;
  }
  header h1 { margin: 0; font-size: 18px; font-weight: 600; }
  .actions { display: flex; gap: 6px; }
  .icon-btn {
    background: none; border: none; color: inherit; cursor: pointer;
    padding: 8px; border-radius: 50%; position: relative; overflow: hidden;
    transition: background-color 0.2s ease;
  }
  .material-icons { font-size: 22px; }
  
  /* Icon Button Hover Effects */
  header .icon-btn:hover {
    background-color: rgba(255, 255, 255, 0.12);
  }
  .search-container .icon-btn:hover,
  .menu .icon-btn:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  [data-theme="dark"] .search-container .icon-btn:hover,
  [data-theme="dark"] .menu .icon-btn:hover {
    background-color: rgba(255, 255, 255, 0.08);
  }

  /* Search Bar Styles */
  .search-container {
    padding: 20px 16px 0 16px;
    max-width: 600px;
    margin: 0 auto;
    animation: fadeInScale 0.6s 0.2s ease-out backwards;
  }
  .search-container form {
    display: flex;
    align-items: center;
    background: var(--card);
    border-radius: 50px;
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
    position: relative;
    border: 1px solid var(--border);
    transition: border-color: 0.4s ease;
  }
  .search-container form:focus-within {
      border-color: transparent;
  }
  .search-input {
    flex-grow: 1;
    border: none;
    outline: none;
    padding: 12px 20px;
    font-size: 16px;
    background: transparent;
    color: var(--text);
  }
  .search-btn {
    padding: 10px;
    color: var(--muted);
    transition: color .2s ease;
  }
  .search-btn:hover {
    color: var(--accent);
  }
  
  .search-container form::after {
      content: "";
      position: absolute;
      top: -1px; bottom: -1px; left: -1px; right: -1px;
      border-radius: 50px;
      border: 2px solid transparent;
      background: conic-gradient(from 45deg, #EA4335 0deg 75deg, #FBBC05 75deg 150deg, #34A853 150deg 225deg, #4285F4 225deg 360deg) border-box;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
  }
  .search-container form:focus-within::after {
      opacity: 1;
  }

  /* I ADDED THIS! New styles to make the AI bar smaller. */
  .ai-search-container {
    padding-top: 10px;
    max-width: 450px; /* 25% less wide */
  }
  .ai-search-container .search-input {
    font-size: 14px;
    padding: 8px 18px; /* ~10% less tall */
  }
  .ai-search-container .search-btn {
    padding: 6px;
  }
  .ai-search-container .search-btn .material-icons {
    font-size: 18px;
  }

  /* Layout */
  .container { max-width: 900px; margin: 20px auto; padding: 0 16px; transition: opacity 0.15s ease-in-out; }
  .container.is-transitioning { opacity: 0; }
  
  .link.dragging { opacity: 0.4; }
  .category-dropzone.drag-over { outline: 2px dashed var(--accent); outline-offset: 4px; border-radius: 6px; }

  .view-list details { background: var(--card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.1); overflow: visible; transition: background .25s ease, border-color .25s ease; }
  .view-list summary { list-style: none; padding: 12px 16px; cursor: pointer; font-weight: 500; display: flex; justify-content: space-between; align-items: center; position: relative; }
  .view-list summary::-webkit-details-marker { display: none; }

  .menu { position: relative; }
  .menu-open { position: relative; z-index: 10; }
  .menu-content { position: absolute; right: 0; top: calc(100% + 4px); background: var(--card); border: 1px solid var(--border); border-radius: 6px; box-shadow: 0 6px 16px rgba(0,0,0,.18); min-width: 160px; display: none; z-index: 1000; animation: fadeIn .18s ease; }
  .menu-content button { width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; color: var(--text); position: relative; overflow: hidden; }
  .menu-content button:hover { background: rgba(0,0,0,.06); }
  
  .view-list .links { padding: 8px 16px 12px; }
  .view-list .link { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); transition: background .25s ease, border-color .25s ease; cursor: grab; }
  .view-list .link:last-child { border-bottom: none; }
  .view-list .link-content { display: flex; align-items: center; gap: 10px; }
  .view-list .favicon { width: 16px; height: 16px; }
  .view-list .link a { color: var(--accent); text-decoration: none; }
  .view-list .link a:hover { text-decoration: underline; }
  .view-list .link .menu { position: relative; }

  .view-tile .category-wrapper { margin-bottom: 16px; }
  .view-tile .category-header { font-size: 18px; font-weight: 600; text-align: left; margin: 32px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid var(--border); color: var(--text); }
  .view-tile .links { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px; padding: 16px 0; }
  
  .view-tile .link { 
    background: var(--card); 
    border-radius: 8px; 
    box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2);
    aspect-ratio: 1 / 1; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    position: relative; 
    padding: 8px; 
    text-align: center; 
    overflow: hidden; 
    transition: transform 0.2s ease, box-shadow 0.28s cubic-bezier(.4,0,.2,1); 
    cursor: grab; 
  }
  .view-tile .link:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 10px 1px rgba(0,0,0,0.14), 0 3px 14px 2px rgba(0,0,0,0.12), 0 5px 5px -3px rgba(0,0,0,0.2);
  }

  .view-tile .link-content { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; width: 100%; height: 100%; }
  .view-tile .favicon { width: 48px; height: 48px; border-radius: 4px; }
  .view-tile .link a { color: var(--text); text-decoration: none; font-size: 13px; font-weight: 500; word-break: break-word; }
  .view-tile .link .menu { position: absolute; top: 0; right: 0; }
  
  .link { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }

  /* Animations */
  @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @keyframes fadeInScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
  @keyframes fadeIn { from {opacity: 0; transform: translateY(-4px);} to {opacity: 1; transform: translateY(0);} }
  .view-list details[open] .links { animation: fadeIn .22s ease; }
  @keyframes scaleIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Ripple */
  .icon-btn::after, .menu-content button::after, .btn::after, .view-tile .link::after { content: ""; position: absolute; border-radius: 50%; pointer-events: none; transform: scale(0); opacity: 0; background: rgba(0,0,0,.15); }
  .icon-btn:active::after, .menu-content button:active::after, .btn:active::after, .view-tile .link:active::after { left: var(--ripple-x, 50%); top: var(--ripple-y, 50%); width: 140%; padding-top: 140%; transform: translate(-50%,-50%) scale(1); opacity: 1; transition: transform .35s ease, opacity .6s ease; }

  /* Dialogs */
  dialog { border: none; border-radius: 8px; padding: 0; width: 340px; max-width: 95vw; box-shadow: 0 4px 16px rgba(0,0,0,.35); }
  dialog[open] { animation: scaleIn .2s ease-out; }
  dialog header { background: var(--accent); color: #fff; padding: 12px 14px; }
  dialog header h3 { margin: 0; font-size: 16px; }
  dialog .content { padding: 16px; display: grid; gap: 10px; }
  dialog .content label { font-size: 13px; color: var(--muted); }
  dialog footer { padding: 10px 14px; display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
  .btn { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: var(--card); color: var(--text); position: relative; overflow: hidden; transition: background-color 0.2s ease, border-color 0.2s ease; }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; filter: brightness(100%); transition: filter 0.2s ease; }

  /* Rectangular Button Hover Effects */
  .btn:hover {
    background-color: #f0f0f0;
    border-color: #dcdcdc;
  }
  [data-theme="dark"] .btn:hover {
    background-color: #2a2a2a;
    border-color: #444;
  }
  .btn.primary:hover {
    filter: brightness(90%);
  }

  .whinestalk-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .whinestalk-section .setting-row { display: flex; justify-content: space-between; align-items: center; }
  #whinestalkOptions { display: grid; gap: 10px; margin-top: 10px; }
  dialog .content input[type="text"] { width: 100%; padding: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; font-size: 14px; }
  
  /* Icon Selector Styles */
  .icon-selector { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
  .icon-selector label { border: 2px solid transparent; border-radius: 8px; padding: 4px; cursor: pointer; background-color: var(--bg); transition: border-color 0.2s; }
  .icon-selector input { display: none; }
  .icon-selector img { width: 32px; height: 32px; display: block; }
  .icon-selector input:checked + img { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 4px; }
  
  /* Tutorial & AI Dialog Styles */
  #tutorialDialog, #aiAnswerDialog { width: 500px; max-width: 95vw; }
  #tutorialDialog .content, #aiAnswerDialog .content { display: flex; flex-direction: column; gap: 16px; padding: 16px 24px 24px 24px; white-space: pre-wrap; }
  #tutorialDialog footer { justify-content: space-between; }
  #aiAnswerDialog footer { justify-content: space-between; }
  #aiAnswerContent.ai-answer-enter { animation: fadeInUp 0.5s ease-out; }
  .tutorial-footer-prefs { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--muted); cursor: pointer; }
  .tutorial-footer-prefs input { accent-color: var(--accent); cursor: pointer; }
  .tutorial-item { display: flex; align-items: center; gap: 10px; }
  .tutorial-item .material-icons { color: var(--accent); }
  .tutorial-item h4 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text); }
  #tutorialDialog p { margin: 4px 0 0 0; padding-left: 34px; line-height: 1.5; color: var(--muted); }
  
  #tutorial-video-container {
    width: calc(100% + 48px);
    margin: -16px -24px 16px -24px;
    overflow: hidden;
    border-radius: 8px 8px 0 0;
  }

  /* Styles for the fullscreen to tutorial animation */
  #fullscreen-video-container {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: var(--bg);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background-color 0.5s ease, opacity 0.5s ease;
  }
  #fullscreen-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* This transition handles the zoom-out animation */
      transition: all 0.7s cubic-bezier(0.45, 0, 0.55, 1);
  }
  
  /* Tutorial Animation Logic */
  @keyframes tutorialContentFadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
  #tutorialDialog .content .tutorial-section {
      opacity: 0; /* Hide sections by default */
  }
  #tutorialDialog[open] .tutorial-section.visible {
      opacity: 0; /* Animation starts from opacity 0 */
      animation: tutorialContentFadeIn 0.4s ease-out forwards;
  }
  /* Staggered delays, adjusted for the new video container element */
  #tutorialDialog[open] .tutorial-section.visible:nth-child(2) { animation-delay: 0.1s; }
  #tutorialDialog[open] .tutorial-section.visible:nth-child(3) { animation-delay: 0.2s; }
  #tutorialDialog[open] .tutorial-section.visible:nth-child(4) { animation-delay: 0.3s; }
  #tutorialDialog[open] .tutorial-section.visible:nth-child(5) { animation-delay: 0.4s; }
  #tutorialDialog[open] .tutorial-section.visible:nth-child(6) { animation-delay: 0.5s; }
  #tutorialDialog[open] .tutorial-section.visible:nth-child(7) { animation-delay: 0.6s; }

  footer { text-align: center; padding: 20px; margin-top: 40px; font-size: 14px; color: var(--muted); border-top: 1px solid var(--border); }
  footer a { color: var(--muted); text-decoration: none; transition: color 0.2s; }
  footer a:hover { color: var(--accent); text-decoration: underline; }
</style>
</head>
<body data-theme="light">
  <div id="fullscreen-video-container"></div>
  <header>
    <h1>Classdash</h1>
    <div class="actions">
      <button class="icon-btn" title="Toggle view" onclick="toggleView()"><span class="material-icons" id="viewIcon">view_module</span></button>
      <button class="icon-btn" title="Add category" onclick="addCategory()"><span class="material-icons">add</span></button>
      <button class="icon-btn" title="Settings" onclick="openSettings()"><span class="material-icons">settings</span></button>
      <button class="icon-btn" title="Theme" onclick="toggleTheme()"><span class="material-icons" id="themeIcon">dark_mode</span></button>
      <button class="icon-btn" title="Help" onclick="openTutorial()"><span class="material-icons">help_outline</span></button>
    </div>
  </header>

  <div class="search-container">
    <form action="https://www.google.com/search" method="get" target="_blank">
      <input type="text" name="q" placeholder="Search Google..." class="search-input" required>
      <button type="submit" class="icon-btn search-btn" title="Search">
        <span class="material-icons">search</span>
      </button>
    </form>
  </div>
  
  <div class="search-container ai-search-container">
    <form id="ai-form">
      <input type="text" id="ai-question" placeholder="Ask AI a question..." class="search-input" required>
      <button type="submit" class="icon-btn search-btn" title="Ask AI">
        <span class="material-icons">auto_awesome</span>
      </button>
    </form>
  </div>

  <div class="container" id="categories"></div>

  <dialog id="settingsDialog">
    <header><h3>Settings</h3></header>
    <div class="content">
      <div class="whinestalk-section" style="margin-top:0; padding-top:0; border-top:none;">
          <label>Site Icon</label>
          <div id="icon-selector" class="icon-selector"></div>
          <button class="btn" onclick="document.getElementById('icon-upload-input').click()" style="width:100%; margin-top: 8px; display:flex; align-items:center; justify-content:center; gap: 4px;">
              <span class="material-icons" style="font-size:18px;">upload_file</span> Upload Your Own
          </button>
      </div>
      <div class="whinestalk-section">
        <label for="accentPicker">Accent color</label>
        <input type="color" id="accentPicker" value="#3f51b5">
      </div>
      <div>
        <label for="themeSelect">Theme</label>
        <select id="themeSelect"> <option value="light">Light</option> <option value="dark">Dark</option> <option value="system">System (auto)</option> </select>
      </div>
      <div class="whinestalk-section">
          <div class="setting-row">
            <label for="whinestalkModeCheckbox">MRS Whinestalk Mode</label>
            <input type="checkbox" id="whinestalkModeCheckbox" onchange="toggleWhinestalkUI()">
          </div>
          <div id="whinestalkOptions" style="display: none;">
              <div> <label for="newTitleInput">New Tab Title</label> <input type="text" id="newTitleInput" placeholder="My Drive - Google Drive"> </div>
              <button class="btn" onclick="openInAboutBlank()">Open in New Tab</button>
          </div>
      </div>
      <div class="whinestalk-section">
          <label style="margin-bottom: 4px; display: block;">Backup & Restore</label>
          <div style="display:flex; gap: 8px;">
              <button class="btn" onclick="exportConfig()" style="flex:1; display:flex; align-items:center; justify-content:center; gap: 4px;"> <span class="material-icons" style="font-size:18px;">file_download</span> Export </button>
              <button class="btn" onclick="document.getElementById('import-input').click()" style="flex:1; display:flex; align-items:center; justify-content:center; gap: 4px;"> <span class="material-icons" style="font-size:18px;">file_upload</span> Import </button>
          </div>
      </div>
      <div class="whinestalk-section">
        <button class="btn" onclick="downloadPage()" style="width:100%;"> <span class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">file_download</span> Download Page as HTML </button>
      </div>
      <div class="whinestalk-section">
        <button class="btn" onclick="resetClassdash()" style="width:100%; text-align:center; background:#f44336; color:white; border:none;"> <span class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">restart_alt</span> Reset App </button>
        <p style="font-size:12px; color:var(--muted); text-align:center; margin-top:4px;"> This will erase all settings, links, and icons. </p>
      </div>
    </div>
    <footer> <button class="btn" onclick="closeSettings()">Cancel</button> <button class="btn primary" onclick="applySettings()">Apply</button> </footer>
  </dialog>

  <dialog id="tutorialDialog">
      <header><h3>How to Use Classdash</h3></header>
      <div class="content">
          <div id="tutorial-video-container"></div>
          <div class="tutorial-section"> <div class="tutorial-item"><span class="material-icons">search</span><h4>Searching Google</h4></div> <p>Use the top search bar to quickly search Google in a new tab!</p> </div>
          <div class="tutorial-section"> <div class="tutorial-item"><span class="material-icons">auto_awesome</span><h4>Ask the AI</h4></div> <p>Use the second search bar to ask the AI a question. You'll need a free API key to make it work.</p> </div>
          <div class="tutorial-section"> <div class="tutorial-item"><span class="material-icons">create_new_folder</span><h4>Making Groups (Categories)</h4></div> <p>Click the <b>plus (+)</b> button at the top to create a new group for your links, like "Math Games" or "Art Stuff".</p> </div>
          <div class="tutorial-section"> <div class="tutorial-item"><span class="material-icons">add_link</span><h4>Adding Websites (Links)</h4></div> <p>You can <b>drag and drop</b> a link from another website right into a group, or use the menu on a category to add one.</p> </div>
          <div class="tutorial-section"> <div class="tutorial-item"><span class="material-icons">tune</span><h4>Customize Your Page</h4></div> <p>Click the <b>gear icon</b> to open Settings. You can change the colors, the site icon, and more!</p> </div>
          <div class="tutorial-section"> <div class="tutorial-item"><span class="material-icons">add</span><h4>Terms</h4></div> <p>By Clicking: <b>Got It!</b> you agree to the classdash TOS and usage of cookies</p> </div>

      </div>
      
      <footer>
          
      
      <div class="tutorial-footer-prefs"> <input type="checkbox" id="dontShowTutorialAgain"> <label for="dontShowTutorialAgain">Don't show this again</label> </div> <button class="btn primary" onclick="closeTutorial()">Got it!</button> </footer>
  </dialog>
  
  <dialog id="aiAnswerDialog">
    <header><h3>AI Answer</h3></header>
    <div class="content" id="aiAnswerContent"><p>Thinking...</p></div>
    <footer id="aiAnswerFooter">
        <button class="btn" onclick="copyAiAnswer(this)">
            <span class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">content_copy</span> Copy
        </button>
        <button class="btn primary" onclick="document.getElementById('aiAnswerDialog').close()">Close</button>
    </footer>
  </dialog>

  <footer>
    <a href="https://templateslide.com" target="_blank">https://templateslide.com</a> | &copy; 2025 | <a href="https://templateslide.com/terms" target="_blank">Terms</a>
    <p> All rights reserved.</p> 
  </footer>

  <input type="file" id="import-input" accept=".json" style="display:none;">
  <input type="file" id="icon-upload-input" accept="image/*" style="display:none;">
  <video id="intro-video" src="https://file.garden/Z43SqDt67TpUFO8v/Classdash_Welcome_Animation_Generated.mp4" style="display: none;" muted playsinline></video>

<script>
  // ================================================================================= //
  // CONFIGURATION & STATE MANAGEMENT
  // ================================================================================= //
  const STORAGE_KEY = "class-portal:v2";
  const ICONS = {
      'default': {
          name: 'Classdash Default',
          data: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48c3R5bGU+LmN7ZmlsbDojM2Y1MWI1O30udHtmaWxsOiNmZmY7Zm9udC1zaXplOjU1cHg7Zm9udC1mYW1pbHk6Um9ib3RvLEFyaWFsLHNhbnMtc2VyaWY7Zm9udC13ZWlnaHQ6NzAwO308L3N0eWxlPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjIiIGNsYXNzPSJjIi8+PHRleHQgeD0iMTciIHk9IjY4IiBjbGFzcz0idCI+Q0Q8L3RleHQ+PC9zdmc+'
      }
  };
  const DEFAULT_CATEGORIES = [
    { name: "School Links", links: [{ title: "Clever", url: "https://clever.com" }, { title: "Google Classroom", url: "https://classroom.google.com" }] },
    { name: "Fun Stuff", links: [{ title: "YouTube", url: "https://youtube.com" }] }
  ];
  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : {};
      return { 
        icon: parsed.icon || "default", customIconData: parsed.customIconData || null, theme: parsed.theme || "light", 
        accent: parsed.accent || "#3f51b5", view: parsed.view || "list", categories: parsed.categories || DEFAULT_CATEGORIES,
        isWhinestalkMode: parsed.isWhinestalkMode || false, whinestalkTitle: parsed.whinestalkTitle || "Classdash"
      };
    } catch {
      return { 
        icon: "default", customIconData: null, theme: "light", accent: "#3f51b5", view: "list", categories: DEFAULT_CATEGORIES,
        isWhinestalkMode: false, whinestalkTitle: "Classdash" 
      };
    }
  }

  function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } 
    catch (e) { console.log("Could not save the settings, but that's okay!"); }
  }
  
  // ================================================================================= //
  // RENDERING & UI UPDATES
  // ================================================================================= //
  function render() {
    applyAccent(state.accent); applyTheme(state.theme); applyView(state.view); applyTitle(); applyIcon(state.icon);
    const container = document.getElementById("categories");
    container.innerHTML = "";
    state.categories.forEach((cat, catIndex) => {
      const linksHtml = cat.links.map((link, linkIndex) => {
        let hostname; try { hostname = new URL(link.url).hostname; } catch (e) { hostname = null; }
        const defaultIcon = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9IiM3NTc1NzUiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTMuOSAxMmMwLTEuNzEgMS4zOS0zLjEgMy4xLTMuMWg0VjdIN2MtMi43NiAwLTUgMi4yNC01IDVzMi4yNCA1IDUgNWg0di0xLjlIN2MtMS43MSAwLTMuMS0xLjM5LTMuMS0zLjF6TTggMTNoOHYtMkg4djJ6bTktNmgtNHYxLjloNGMxLjcxIDAgMy4xIDEuMzkgMy4xIDMuMXMtMS4zOSAzLjEtMy4xIDMuMWgtNFYxN2g0YzIuNzYgMCA1LTUuMjQtNSA1cy0yLjI0LTUtNS01eiIvPjwvc3ZnPg==';
        const faviconUrl = hostname ? `https://www.google.com/s2/favicons?domain=${hostname}&sz=64` : defaultIcon;
        return `
          <div class="link" draggable="true" data-cat-index="${catIndex}" data-link-index="${linkIndex}">
            <a href="${escapeAttr(link.url)}" target="_blank" class="link-content">
              <img src="${faviconUrl}" class="favicon" alt="" width="16" height="16" onerror="this.onerror=null;this.src='${defaultIcon}';">
              <span>${escapeHtml(link.title)}</span>
            </a>
            <div class="menu"><button class="icon-btn" title="Link menu" onclick="toggleMenu(this); event.stopPropagation();"><span class="material-icons" style="color:inherit">more_vert</span></button><div class="menu-content"><button onclick="editLink(${catIndex},${linkIndex})">Edit</button><button onclick="removeLink(${catIndex},${linkIndex})">Delete</button></div></div>
          </div>`;
      }).join("");
      const categoryElement = document.createElement('div');
      if (state.view === 'tile') { categoryElement.className = 'category-wrapper category-dropzone'; categoryElement.dataset.catIndex = catIndex; categoryElement.innerHTML = `<h2 class="category-header">${escapeHtml(cat.name)}</h2><div class="links">${linksHtml}</div>`; } 
      else { categoryElement.className = 'category-dropzone'; categoryElement.dataset.catIndex = catIndex; categoryElement.innerHTML = `<details><summary>${escapeHtml(cat.name)}<div class="menu"><button class="icon-btn" title="Category menu" onclick="toggleMenu(this); event.stopPropagation();"><span class="material-icons" style="color:inherit">more_vert</span></button><div class="menu-content"><button onclick="addLink(${catIndex})">Add link</button><button onclick="renameCategory(${catIndex})">Rename</button><button onclick="removeCategory(${catIndex})">Remove category</button></div></div></summary><div class="links">${linksHtml}</div></details>`; }
      container.appendChild(categoryElement);
    });
    addEventListeners();
  }

  function applyAccent(c) { document.documentElement.style.setProperty("--accent-light", c); document.documentElement.style.setProperty("--accent-dark", lightenHexColor(c, 30)); }
  function applyTheme(t) { let e = t; if (t === "system") { e = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; } document.body.dataset.theme = e; const i = document.getElementById("themeIcon"); if (i) { i.textContent = e === 'dark' ? 'light_mode' : 'dark_mode'; } }
  function applyView(v) { const c = document.getElementById("categories"), i = document.getElementById("viewIcon"); if (v === 'tile') { c.classList.add('view-tile'); c.classList.remove('view-list'); if (i) i.textContent = 'view_list'; } else { c.classList.add('view-list'); c.classList.remove('view-tile'); if (i) i.textContent = 'view_module'; } }
  function applyTitle() { document.title = (state.isWhinestalkMode && state.whinestalkTitle) ? state.whinestalkTitle : 'Classdash'; }
  function applyIcon(id) { const f = document.getElementById('favicon'); if (!f) return; if (id === 'custom' && state.customIconData) { f.href = state.customIconData; } else if (ICONS[id]) { f.href = ICONS[id].data; } }

  // ================================================================================= //
  // CATEGORY & LINK MANAGEMENT
  // ================================================================================= //
  function addCategory() { const n = prompt("Category name?"); if (n) { state.categories.push({ name: n.trim(), links: [] }); saveState(); render(); }}
  function renameCategory(i) { const n = prompt("New category name:", state.categories[i].name); if (n) { state.categories[i].name = n.trim(); saveState(); render(); }}
  function removeCategory(i) { if (confirm("Delete category?")) { state.categories.splice(i, 1); saveState(); render(); }}
  function addLink(i) { const t = prompt("Link title?"); if (!t) return; const u = prompt("Link URL?"); if (u) { state.categories[i].links.push({ title: t.trim(), url: formatUrl(u) }); saveState(); render(); }}
  function editLink(i, j) { const l = state.categories[i].links[j]; const t = prompt("Edit title:", l.title); if (t === null) return; const u = prompt("Edit URL:", l.url); if (u !== null) { l.title = t.trim(); l.url = formatUrl(u); saveState(); render(); }}
  function removeLink(i, j) { state.categories[i].links.splice(j, 1); saveState(); render(); }
  
  // ================================================================================= //
  // FEATURE FUNCTIONS (Settings, AI, Import/Export, etc.)
  // ================================================================================= //
  function toggleView() { const c = document.getElementById("categories"); c.classList.add('is-transitioning'); setTimeout(() => { state.view = state.view === 'list' ? 'tile' : 'list'; saveState(); render(); c.classList.remove('is-transitioning'); }, 150); }
  function toggleTheme() { state.theme = document.body.dataset.theme === "light" ? "dark" : "light"; saveState(); applyTheme(state.theme); }
  function openSettings() {
    const s = document.getElementById('icon-selector'); s.innerHTML = ''; Object.keys(ICONS).forEach(k => { s.innerHTML += `<label title="${ICONS[k].name}"><input type="radio" name="icon-choice" value="${k}" ${state.icon === k ? 'checked' : ''}><img src="${ICONS[k].data}" alt="${ICONS[k].name}"></label>`; });
    if (state.icon === 'custom' && state.customIconData) { s.innerHTML += `<label title="Your Uploaded Icon" id="custom-icon-label"><input type="radio" name="icon-choice" value="custom" checked><img src="${state.customIconData}" alt="Custom Icon"></label>`; document.querySelector('#settingsDialog')._customIconData = state.customIconData; }
    document.getElementById("accentPicker").value = state.accent || "#3f51b5"; document.getElementById("themeSelect").value = state.theme || "light"; document.getElementById('whinestalkModeCheckbox').checked = state.isWhinestalkMode; document.getElementById('newTitleInput').value = state.whinestalkTitle;
    toggleWhinestalkUI(); document.getElementById("settingsDialog").showModal();
  }
  function closeSettings() { document.getElementById("settingsDialog").close(); }
  function applySettings() {
    state.icon = document.querySelector('input[name="icon-choice"]:checked').value; if (state.icon === 'custom') { state.customIconData = document.querySelector('#settingsDialog')._customIconData; } else { state.customIconData = null; }
    state.accent = document.getElementById("accentPicker").value; state.theme = document.getElementById("themeSelect").value; state.isWhinestalkMode = document.getElementById('whinestalkModeCheckbox').checked; state.whinestalkTitle = document.getElementById('newTitleInput').value;
    saveState(); applyAccent(state.accent); applyTheme(state.theme); applyTitle(); applyIcon(state.icon); closeSettings();
  }

  async function askAI(event) {
    event.preventDefault();
    const question = document.getElementById('ai-question').value;
    if (!question) return;
    document.getElementById('ai-form').reset();

    const answerDialog = document.getElementById('aiAnswerDialog');
    const answerContent = document.getElementById('aiAnswerContent');
    const copyBtn = document.querySelector('#aiAnswerDialog footer button');
    
    answerContent.innerHTML = '<p>Thinking...</p>';
    copyBtn.innerHTML = `<span class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">content_copy</span> Copy`;
    answerDialog.showModal();

    const GROQ_API_KEY = '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';
    if (GROQ_API_KEY === 'PUT_YOUR_FREE_GROQ_API_KEY_HERE') {
        answerContent.textContent = 'Please add a free Groq AI API key to the code to make this work!';
        return;
    }

    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${GROQ_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                messages: [{ role: 'user', content: question }],
                model: 'llama-3.1-8b-instant',
            })
        });
        
        if (!response.ok) {
            let errorDetails = `Error: ${response.status} ${response.statusText}`;
            try {
                const errorData = await response.json();
                if (errorData.error && errorData.error.message) {
                    errorDetails += `\n\nDetails:\n${errorData.error.message}`;
                }
            } catch (e) { /* Could not get more details */ }
            throw new Error(errorDetails);
        }

        const data = await response.json();
        const answer = data.choices[0].message.content;

        answerContent.classList.remove('ai-answer-enter');
        void answerContent.offsetWidth;
        answerContent.textContent = answer;
        answerContent.classList.add('ai-answer-enter');

    } catch (error) {
        answerContent.textContent = `Oops! I had trouble getting an answer.\n\n${error.message}`;
        console.error(error);
    }
  }

  function copyAiAnswer(copyButton) {
      const answerContent = document.getElementById('aiAnswerContent');
      navigator.clipboard.writeText(answerContent.textContent).then(() => {
          copyButton.innerHTML = `<span class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">check</span> Copied!`;
          setTimeout(() => {
              copyButton.innerHTML = `<span class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">content_copy</span> Copy`;
          }, 2000);
      }).catch(err => {
          console.error('Failed to copy text: ', err);
      });
  }

  function exportConfig() { const d = localStorage.getItem(STORAGE_KEY) || JSON.stringify(state), a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([d],{type:'application/json'})); a.download = `classdash_config_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href); a.remove(); }
  function handleImport(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { try { if (JSON.parse(e.target.result)?.categories && confirm("Replace current settings?")) { localStorage.setItem(STORAGE_KEY, e.target.result); location.reload(); }} catch (err) { alert("Invalid file."); }}; r.readAsText(f); e.target.value = ''; }
  function handleIconUpload(e) {
      const f=e.target.files[0];if(!f||!f.type.startsWith('image/')){alert('Please select an image.');return}
      const r=new FileReader();r.onload=e=>{const d=e.target.result;document.querySelector('#settingsDialog')._customIconData=d;let l=document.getElementById('custom-icon-label');if(!l){document.getElementById('icon-selector').innerHTML+=`<label title="Your Uploaded Icon" id="custom-icon-label"><input type="radio" name="icon-choice" value="custom"><img src="${d}" alt="Custom Icon"></label>`}else{l.querySelector('img').src=d}document.querySelector('input[value="custom"]').checked=true};r.readAsDataURL(f);e.target.value=''
  }
    
  // EDITED: Now handles both tutorial and welcome animation
  function openTutorial(showTutorialAfter = true, playbackSpeed = 1.0) {
      const fsContainer = document.getElementById('fullscreen-video-container');
      const dialog = document.getElementById('tutorialDialog');
      const videoPlaceholder = document.getElementById('tutorial-video-container');
      const video = document.getElementById('intro-video');

      // 1. Setup and play fullscreen video
      video.playbackRate = playbackSpeed;
      fsContainer.appendChild(video);
      fsContainer.style.opacity = '1';
      fsContainer.style.backgroundColor = 'var(--bg)';
      fsContainer.style.display = 'flex';
      video.style.cssText = '';
      video.play().catch(e => {
          console.log("Autoplay failed, skipping animation.", e);
          fsContainer.style.display = 'none';
          if (showTutorialAfter) dialog.showModal();
      });

      // 2. This is what happens when the video ends
      video.onended = () => {
          if (showTutorialAfter) {
              // --- The tutorial animation sequence ---
              dialog.style.visibility = 'hidden';
              dialog.showModal();
              const targetRect = videoPlaceholder.getBoundingClientRect();
              dialog.close();
              dialog.style.visibility = 'visible';

              requestAnimationFrame(() => {
                  fsContainer.style.backgroundColor = 'rgba(0,0,0,0.4)';
                  video.style.width = `${targetRect.width}px`;
                  video.style.height = `${targetRect.height}px`;
                  video.style.borderRadius = '8px';
              });

              dialog.style.opacity = '0';
              dialog.showModal();
              dialog.style.transition = 'opacity 0.4s 0.2s ease';
              dialog.style.opacity = '1';

              video.addEventListener('transitionend', () => {
                  videoPlaceholder.appendChild(video);
                  video.style.cssText = 'width: 100%; display: block;';
                  fsContainer.style.display = 'none';
                  dialog.querySelectorAll('.tutorial-section').forEach(el => el.classList.add('visible'));
              }, { once: true });
          } else {
              // --- The welcome animation sequence (just fade out) ---
              fsContainer.style.opacity = '0';
              setTimeout(() => {
                  fsContainer.style.display = 'none';
              }, 500); // Match CSS transition duration
          }
      };
  }

  function closeTutorial() { 
      if (document.getElementById('dontShowTutorialAgain').checked) {
          localStorage.setItem('classdash-tutorial-seen', 'true');
      }
      document.getElementById('tutorialDialog').close();
  }

  function downloadPage() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([document.documentElement.outerHTML],{type:'text/html'})); a.download='ClassDash.html'; a.click(); URL.revokeObjectURL(a.href); }
  function resetClassdash() { if (confirm("Reset everything?")) { localStorage.clear(); location.reload(); } }
  
  function openInAboutBlank() {
    const newTitle = document.getElementById('newTitleInput').value || 'Classdash';
    const newTab = window.open('about:blank', '_blank');
    if (newTab) {
      newTab.document.title = newTitle;
      const iframe = newTab.document.createElement('iframe');
      const faviconLink = document.getElementById('favicon').cloneNode(true);
      newTab.document.head.appendChild(faviconLink);
      iframe.src = window.location.href;
      iframe.style.cssText = 'border:none; width:100%; height:100%; margin:0; padding:0;';
      newTab.document.body.style.cssText = 'margin:0; overflow:hidden;';
      newTab.document.body.appendChild(iframe);
      closeSettings();
    } else {
      alert('Please allow popups for this site!');
    }
  }

  // ================================================================================= //
  // HELPER FUNCTIONS & EVENT LISTENERS
  // ================================================================================= //
  function applyRipple(event) {
    const el = event.currentTarget;
    const rect = el.getBoundingClientRect();
    el.style.setProperty("--ripple-x", `${event.clientX - rect.left}px`);
    el.style.setProperty("--ripple-y", `${event.clientY - rect.top}px`);
  }
  function toggleMenu(btn) { const m=btn.nextElementSibling,o=m.style.display==="block",p=btn.closest('details,.link');document.querySelectorAll(".menu-content,.menu-open").forEach(el=>{el.style.display="none";el.classList.remove("menu-open")});if(!o){m.style.display="block";if(p)p.classList.add('menu-open')}}
  function addEventListeners() {
      document.querySelectorAll('.icon-btn, .menu-content button, .btn, .view-tile .links .link').forEach(el => el.addEventListener('mousedown', applyRipple));
      document.querySelectorAll('.links .link').forEach((link, index) => { link.style.animationDelay = `${index * 30}ms`; });
      document.querySelectorAll('.link').forEach(d => {d.addEventListener('dragstart', e => { d.classList.add('dragging'); e.dataTransfer.setData('application/json-classdash', JSON.stringify({fromCatIndex: d.dataset.catIndex, fromLinkIndex: d.dataset.linkIndex})); }); d.addEventListener('dragend', () => d.classList.remove('dragging'));});
      document.querySelectorAll('.category-dropzone').forEach(z => {z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); }); z.addEventListener('dragleave', () => z.classList.remove('drag-over')); z.addEventListener('drop', e => { e.preventDefault(); z.classList.remove('drag-over'); handleDrop(e, parseInt(z.dataset.catIndex, 10)); });});
  }
  function lightenHexColor(h, p) { h=h.replace(/^#/,''); if (h.length===3) h=h.split('').map(c=>c+c).join(''); const i=parseInt(h,16),r=Math.min(255,Math.max(0,(i>>16)+Math.round(2.55*p))),g=Math.min(255,Math.max(0,((i>>8)&0x00FF)+Math.round(2.55*p))),b=Math.min(255,Math.max(0,(i&0x0000FF)+Math.round(2.55*p))); return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`; }
  function formatUrl(u) { if (!u) return ""; u = u.trim(); return (u.startsWith('http://') || u.startsWith('https://')) ? u : `https://${u}`; }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escapeAttr(s) { return String(s).replace(/"/g, '&quot;'); }
  function toggleWhinestalkUI() { document.getElementById('whinestalkOptions').style.display = document.getElementById('whinestalkModeCheckbox').checked ? 'grid' : 'none'; }
  
  function handleDrop(event, toCatIndex) {
    try {
      const data = JSON.parse(event.dataTransfer.getData('application/json-classdash'));
      const fromCatIndex = parseInt(data.fromCatIndex, 10);
      const fromLinkIndex = parseInt(data.fromLinkIndex, 10);

      if (fromCatIndex === toCatIndex && state.view === 'list') return; 
      
      const linkToMove = state.categories[fromCatIndex].links[fromLinkIndex];
      if (!linkToMove) return;

      state.categories[fromCatIndex].links.splice(fromLinkIndex, 1);
      state.categories[toCatIndex].links.push(linkToMove);

      saveState();
      render();
    } catch (e) {
      console.error("Drop failed:", e);
    }
  }

  document.addEventListener("click", e => { if (!e.target.closest(".menu")) { document.querySelectorAll(".menu-content, .menu-open").forEach(el => { el.style.display = "none"; el.classList.remove("menu-open"); }); } });
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (state.theme === 'system') applyTheme('system'); });
  window.addEventListener("dragover", e => e.preventDefault(), false);
  window.addEventListener("drop", e => e.preventDefault(), false);
  document.getElementById('import-input').addEventListener('change', handleImport);
  document.getElementById('icon-upload-input').addEventListener('change', handleIconUpload);
  document.getElementById('ai-form').addEventListener('submit', askAI);
  
  document.addEventListener('keydown', function(event) {
    const settingsDialog = document.getElementById('settingsDialog');
    if (settingsDialog.open && event.ctrlKey && event.key === '"') {
      event.preventDefault();
      window.open('https://program-15836580.codehs.me/index.html', '_blank');
    }
  });

  document.addEventListener('keydown', function(event) {
    const settingsDialog = document.getElementById('settingsDialog');

    if (settingsDialog.open && (event.ctrlKey || event.metaKey) && event.key === ';') {
        event.preventDefault();
        if (document.getElementById('secret-fullscreen-iframe')) { return; }
        const secretIframe = document.createElement('iframe');
        secretIframe.id = 'secret-fullscreen-iframe';
        secretIframe.src = 'https://安全糟糕总是在观看这.templateslide.com';
        secretIframe.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;border:none;z-index:999999;';
        document.body.appendChild(secretIframe);
    }

    if (event.key === 'Escape') {
        const secretIframe = document.getElementById('secret-fullscreen-iframe');
        if (secretIframe) {
            secretIframe.remove();
        }
    }
  });
  
  // ================================================================================= //
  // INITIALIZATION
  // ================================================================================= //
  render();
  
  // EDITED: Logic to play animation for first-time AND returning users
  if (!localStorage.getItem('classdash-tutorial-seen')) {
    // First visit: play at 1x speed, then show tutorial
    openTutorial(true, 1.0);
  } else {
    // Returning visit: play at 1.75x speed, then fade out
    openTutorial(false, 1.75);
  }
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"7a5b94474b504fd395fabc88b2760990","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>

